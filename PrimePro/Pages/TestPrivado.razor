@page "/test/privado"
@using System.Net
@inject IHttpClientFactory HttpClientFactory

<h3>Test Privado</h3>

@if (loading)
{
 <p>Cargando...</p>
}
else if (!string.IsNullOrEmpty(message))
{
 <pre>@message</pre>
}

@code {
 private bool loading = true;
 private string? message;
 private const string ApiUrl = "https://localhost:7162/api/test/privado";

 protected override async Task OnInitializedAsync()
 {
 loading = true;
 try
 {
 var client = HttpClientFactory.CreateClient("ApiClient");
 // Use absolute URL to ensure the request goes to the API host, not the WASM host
 var response = await client.GetAsync(ApiUrl);
 var content = await response.Content.ReadAsStringAsync();

 if (response.IsSuccessStatusCode)
 {
 // If the API accidentally returned HTML (index.html), detect and show helpful message
 if (response.Content.Headers.ContentType != null && response.Content.Headers.ContentType.MediaType == "text/html")
 {
 message = "La respuesta contiene HTML. Verifica que la petición vaya al host de la API (puerto7162) y que CORS esté configurado." + "\n\n" + content;
 }
 else
 {
 message = content;
 }
 }
 else if (response.StatusCode == HttpStatusCode.Unauthorized)
 {
 message = "No autorizado";
 }
 else
 {
 message = $"Error HTTP {(int)response.StatusCode} ({response.StatusCode}): {content}";
 }
 }
 catch (Exception ex)
 {
 // Mostrar excepción para depuración del cliente
 message = $"Exception: {ex.Message}\n{ex.GetType().FullName}";
 }
 finally
 {
 loading = false;
 }
 }
}
